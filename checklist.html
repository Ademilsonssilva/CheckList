<!doctype html>
<html lang="en">
  	<head>
    	<!-- Required meta tags -->
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    	<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		
		<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
		<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
		
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
		
    	<title>Firebase CheckList</title>
  	</head>
  	<body>
	
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        	<a class="navbar-brand" href="#">CheckList</a>
	        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
	          	<span class="navbar-toggler-icon"></span>
	        </button>
	        <div class="collapse navbar-collapse" id="navbarCollapse">
	          	<ul class="navbar-nav mr-auto">
	            	<li class="nav-item active">
	             		<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
	            	</li>
	            	<li class="nav-item">
	              		<a class="nav-link" id="logout" href="#">Logout</a>
            		</li>
	            	<li class="nav-item">
	              		<a class="nav-link" href="new_coach_user.html">Usuários</a>
	            	</li>
	          	</ul>
	          	<form class="form-inline mt-2 mt-md-0">
	            	<input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
	            	<button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
	          	</form>
	        </div>
      	</nav>
			
        <div class="container" style='padding-top:100px'>
			<div class='row'>

				<div class='col-sm-12'>
					<h2>CheckList de Hábitos</h2>

				</div>
			</div>
			
			<div class='row'>
				
				<div class='col-sm-6'>
			
					<label>Ano</label>
					<input class="form-control" id="field_ano" name="field_ano" type="number" value=2018 maxlength="4"/>
				</div>
				
				<div class='col-sm-6'>
					<label>Mês</label>
					<select id="field_meses" class="form-control" name="field_meses">
						<option value='0'>JAN</option>
						<option value='1'>FEV</option>
						<option value='2'>MAR</option>
						<option value='3'>ABR</option>
						<option value='4'>MAI</option>
						<option value='5'>JUN</option>
						<option value='6'>JUL</option>
						<option value='7'>AGO</option>
						<option value='8'>SET</option>
						<option value='9'>OUT</option>
						<option value='10'>NOV</option>
						<option value='11'>DEZ</option>
					</select>
				</div>
					
			</div>
				
			<div class='row table-responsive' style='padding-top:15px'>
				<div class="col-sm-12">
					<table class="table table-sm table-bordered" >
						
						<thead id='headChecklist' class='table-dark'>
						
						</thead>
						
						<tbody id='checklist'>
						
						</tbody>
					</table>
				</div>
			</div>
		</div>
		
		
	    <!-- Optional JavaScript -->
	    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		 
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
		<script src="https://www.gstatic.com/firebasejs/5.6.0/firebase.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.29.2/sweetalert2.all.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
		<script src="js/firebase.js"></script>
       <!-- <script src="js/sessao.js"></script>-->
		
		<script>
			var diaDeHoje = new Date();
			//alert(diaDeHoje.getFullYear());

			$('#field_meses').on('change', function(){
				$('#checklist').html("");
				
				field_meses = $(this).val();
				
				fdb.ref('itens').once('value').then(function(snapshot){
					
					snapshot.forEach(function(child){
						
						carregaChecklist(child, $("#field_ano").val(),field_meses);
						
					});
				});
			});
			
			var myUserId;
			
			function marcaCheckList(ev){
				
				if($(ev).html() == ""){					
					firebase.database().ref('users-cliente/' + myUserId + '/' +$(ev).attr('item') +'/' + $(ev).attr('ano') + '/' + $(ev).attr('mes') + '/' + $(ev).attr('dia')).set(true);					
					$(ev).html("<span style='color:green' class='far fa-check-circle'></span>");
				}
				else{
					firebase.database().ref('users-cliente/' + myUserId + '/' +$(ev).attr('item') +'/' + $(ev).attr('ano') + '/' + $(ev).attr('mes') + '/' + $(ev).attr('dia')).set(false);
					$(ev).html("");
				}
			}
			
			function createTd(item, ano, mes, dia, x){

				if(dia == diaDeHoje.getDate() && mes == (diaDeHoje.getMonth() +1) && diaDeHoje.getFullYear() == ano){
					return "<td style='width:27px;background:#eee' onclick='marcaCheckList(this)' align='center' item="+ item +" ano="+ ano +" mes="+ mes +" dia="+ dia +">" + x + "</td>";	
				}
			
				return "<td style='width:27px' onclick='marcaCheckList(this)' align='center' item="+ item +" ano="+ ano +" mes="+ mes +" dia="+ dia +">" + x + "</td>";
			}
			
			function carregaChecklist(item, ano, mes){
					
				var anoSel = parseInt(ano);
				var mesSel = parseInt(mes) + 1;
				//alert('users-cliente/' +  myUserId + '/'+item+'/'+anoSel+'/'+mesSel )
				firebase.database().ref('users-cliente/' + myUserId).once('value').then(function(snap){
					
					if(!snap.exists()){
						firebase.database().ref('users-cliente/' +  myUserId + '/'+item.key+'/'+anoSel+'/'+mesSel ).set('');
					}else{
						
					}
				});
				
				var date = new Date(anoSel, (mesSel - 1), 1);
				
				var days = [];
				
				var trHeader = $("<tr></tr>");
				
				trHeader.append("<th width='150px'>Hábito</th>");	
				while (date.getMonth() === (mesSel - 1) /* && date.getDate() != 8*/) {
								
					trHeader.append("<td ano="+ ano +" mes='" + mesSel  +"' dia='" + (date.getDate())  +"'>" + (date.getDate()) +"</td>");
					days.push(date.getDate());
					date.setDate(date.getDate() + 1);
				
				}
				
				$("#headChecklist").html(trHeader);
				
				var tBody = $("<tr></tr>");
				
				tBody.append("<td width='100px'>"+item.val().nome+"</td>");				
				
				firebase.database().ref('users-cliente/'+ myUserId+'/'+item.key+'/'+ anoSel + '/' + mesSel).once("value").then(function(snapshot){
					
					for (var i = 0; i < days.length; i++) {
						if(snapshot.child(i+1).val()){									
							//teste = 'treinoperna_' + anoSel + '_' + mesSel + '_' + (i+1);									
							tBody.append(createTd(item.key, anoSel, mesSel, (i+1), "<span style='color:green'  class='far fa-check-circle'></span>"));									
						}
						else{
							tBody.append(createTd(item.key, anoSel, mesSel, (i+1), '' ));
						}
					}
					
				});
				
				$("#checklist").append(tBody);
					
			}
			
			firebase.auth().onAuthStateChanged(function(user) {
			
				if (user) {
					
					myUserId = firebase.auth().currentUser.uid;
					
				} 
				else {
         
        			//window.location.href = 'login.html';
            
				}

    });
		</script>

  	</body>
</html>