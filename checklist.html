<!doctype html>
<html lang="en">
  	<head>
		<meta charset="utf-8">

		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Checklist</title>

		<script src="html_base/libraries.js"></script>	 
	</head>
  	<body>
	
       <script src="html_base/navbar.js"></script>
			
        <div class="container" style='padding-top:100px'>
			<div class='row'>

				<div class='col-sm-12'>
					<h2>CheckList de Hábitos</h2>
				</div>
			</div>
			<br />
			<div class='row'>
				
				<div class='col-sm-6'>
			
					<label>Ano</label>
					<input class="form-control" id="field_ano" name="field_ano" type="number" value=2018 maxlength="4"/>
				</div>
				
				<div class='col-sm-6'>
					<label>Mês</label>
					<select id="field_meses" class="form-control" name="field_meses">
						<option value='0'>Janeiro</option>
						<option value='1'>Fevereiro</option>
						<option value='2'>Março</option>
						<option value='3'>Abril</option>
						<option value='4'>Maio</option>
						<option value='5'>Junho</option>
						<option value='6'>Julho</option>
						<option value='7'>Agosto</option>
						<option value='8'>Setembro</option>
						<option value='9'>Outubro</option>
						<option value='10'>Novembro</option>
						<option value='11'>Dezembro</option>
					</select>
				</div>
					
			</div>
				
			<div class='row table-responsive' style='padding-top:15px'>
				<div class="col-sm-12">
					<table class="table table-sm table-bordered" id="tbl_checklist">
						
						<thead id='headChecklist' class='table-dark'>
						
						</thead>
						
						<tbody id='checklist'>
						
						</tbody>
					</table>
				</div>
			</div>
			
			<div class="row">
				
				<div class="col-sm-12">
				<button type="button" class="btn btn-primary" onclick="compartilhar()" data-toggle="modal" data-target="#exampleModal">
					Compartilhar
				</button>

				<!-- Modal -->
				<div class="modal fade" id="exampleModal" tabindex="-1" style='width:100%' role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
				  <div class="modal-dialog modal-lg" role="document">
					 <div class="modal-content">
						<div class="modal-header">
						  <h5 class="modal-title" id="exampleModalLabel">Compartilhar</h5>
						  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
							 <span aria-hidden="true">&times;</span>
						  </button>
						</div>
						<div class="modal-body">
						  
						</div>
						<div class="modal-footer">
						  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						  <button type="button" class="btn btn-primary">Save changes</button>
						</div>
					 </div>
				  </div>
				</div>
			</div>
			</div>
		</div>
		
	   <script src="html_base/scripts_base.js"></script>
      		
		<script>
			function compartilhar(){
			
				table = $("<table class='table table-sm'></table>")
			
				$(".modal-body").html(table.append($("#tbl_checklist").html()));
			}
		
			var diaDeHoje = new Date();
			//alert(diaDeHoje.getFullYear());

			$('#field_meses').on('change', function(){
				$('#checklist').html("");
				
				$('#checklist').html("<tr><td>Carregando</td></tr>");
				
				field_meses = $(this).val();
				$("#tbl_checklist").hide();
				fdb.ref('itens').orderByChild('nome').once('value').then(function(snapshot){
					
					snapshot.forEach(function(child){
						
						carregaChecklist(child, $("#field_ano").val(),field_meses);
						
					});					
				});
				
				$("#tbl_checklist").show();
			});
			
			var myUserId;
			
			function marcaCheckList(ev){
				
				urlCheckList = myUserId + '/' +$(ev).attr('item') +'/' + $(ev).attr('ano') + '/' + $(ev).attr('mes') + '/' + $(ev).attr('dia');
				
				if($(ev).html() == ""){					
					firebase.database().ref('users-cliente/' + urlCheckList).set(true, function(erro){
						if(erro){
							swal({
								
								html : "<b>Não foi possivel efetuar a operação</b>",
								toast : true,
								type : 'error',
								timer: 1200
							});
						}
						else{
							swal({
								
								html : "<b>Hábito registrado</b>",
								toast : true,
								type : 'success',
								position: 'top-end',
								showConfirmButton: false,
								timer: 1200
							});
						
						//alert('tudo ok')
						}
					});
					$(ev).html("<span style='color:green' class='fas fa-check'></span>");
				}
				else{
					firebase.database().ref('users-cliente/' + urlCheckList).set(false, function(erro){
						if(erro){
						
							swal({
								
								html : "<b>Não foi possivel efetuar a operação</b>",
								toast : true,
								type : 'error',
								timer: 1200
							});
						}
						else{
							
							swal({
								
								html : "<b>Hábito desmarcado com sucesso</b>",
								toast : true,
								type : 'success',
								position: 'top-end',
								showConfirmButton: false,
								timer: 1200
							});
						
						}
					});
					$(ev).html("");
				}
			}
			
			function createTd(item, ano, mes, dia, x){

				if(dia == diaDeHoje.getDate() && mes == (diaDeHoje.getMonth() +1) && diaDeHoje.getFullYear() == ano){
					return "<td style='width:27px;background:#eee' onclick='marcaCheckList(this)' align='center' item="+ item +" ano="+ ano +" mes="+ mes +" dia="+ dia +">" + x + "</td>";	
				}
			
				return "<td style='width:27px' onclick='marcaCheckList(this)' align='center' item="+ item +" ano="+ ano +" mes="+ mes +" dia="+ dia +">" + x + "</td>";
			}
			
			function carregaChecklist(item, ano, mes){
					
				var anoSel = parseInt(ano);
				var mesSel = parseInt(mes) + 1;
				
				firebase.database().ref('users-cliente/' + myUserId).once('value').then(function(snap){
					
					if(!snap.exists()){
						firebase.database().ref('users-cliente/' +  myUserId + '/'+item.key+'/'+anoSel+'/'+mesSel ).set('');
					}else{
						
					}
				});
				
				var date = new Date(anoSel, (mesSel - 1), 1);
				var days = [];
				var trHeader = $("<tr></tr>");
				
				trHeader.append("<th width='130px'>Hábito</th>");	
				while (date.getMonth() === (mesSel - 1) /* && date.getDate() != 8*/) {
					
					trHeader.append("<td align='center' ano="+ ano +" mes='" + mesSel  +"' dia='" + (date.getDate())  +"'>" + (date.getDate()) +"</td>");
					days.push(date.getDate());
					date.setDate(date.getDate() + 1);
				}
				
				$("#headChecklist").html(trHeader);
				
				var tBody = $("<tr></tr>");
				
				//tBody.hide();
				tBody.append("<td width='90px'>"+item.val().nome+"</td>");				
				
				firebase.database().ref('users-cliente/'+ myUserId+'/'+item.key+'/'+ anoSel + '/' + mesSel).once("value").then(function(snapshot){
					
					for (var i = 0; i < days.length; i++) {
						if(snapshot.child(i+1).val()){									
							//teste = 'treinoperna_' + anoSel + '_' + mesSel + '_' + (i+1);									
							tBody.append(createTd(item.key, anoSel, mesSel, (i+1), "<span style='color:green' class='fas fa-check'></span>"));									
						}
						else{
							tBody.append(createTd(item.key, anoSel, mesSel, (i+1), '' ));
						}
					}
					
					//tBody.show();
					
				});
								
				$("#checklist").append(tBody);
								
				$("td[dia='"+diaDeHoje.getDate()+"'][mes='"+(diaDeHoje.getMonth()+1)+"'][ano='"+diaDeHoje.getFullYear()+"']").css({
					color: "gold",
					fontWeight:"bold"
				});
				
			}
			
			firebase.auth().onAuthStateChanged(function(user) {
			
				if (user) {
					
					myUserId = firebase.auth().currentUser.uid;
					
					init();
				} 
				else {
         
        			//window.location.href = 'login.html';
				}
			});
			
			function init(){
				
				$("#field_ano").val(diaDeHoje.getFullYear())
				$("#field_meses").val(diaDeHoje.getMonth())
				
				fdb.ref('itens').orderByChild('nome').once('value').then(function(snapshot){
					
					snapshot.forEach(function(child){
						
						carregaChecklist(child, diaDeHoje.getFullYear(),diaDeHoje.getMonth());
						
					});
				});
			}
			
		</script>

  	</body>
</html>